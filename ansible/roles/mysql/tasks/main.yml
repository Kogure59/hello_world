---
- name: Remove mariadb-libs
  yum:
    name: mariadb-libs
    state: absent

- name: Install MySQL 8.4 community release RPM
  yum:
    name: https://dev.mysql.com/get/mysql84-community-release-el7-1.noarch.rpm
    state: present
  register: mysql_rpm_installed

- name: Disable MySQL 5.7 community repository
  command: yum-config-manager --disable mysql57-community
  when: mysql_rpm_installed.changed 

- name: Enable mysql84-community
  command: yum-config-manager --enable mysql84-community
  when: mysql_rpm_installed.changed 

- name: install mysql-community-client
  yum:
    name: mysql-community-client
    state: present

- name: Install MySQL development tools
  yum:
    name: mysql-community-devel
    state: present

- name: Run application setup script
  become: no
  shell: bash -lc "bin/setup"
  args:
    chdir: "{{ app_directory }}"
  when: mysql_rpm_installed.changed

- name: Precompile application assets
  become: no
  shell: bash -lc "rails assets:precompile"
  args:
    chdir: "{{ app_directory }}"
  when: ansible_env.rails_env == 'production'  # 本番環境の時のみ