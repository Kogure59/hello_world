---
- name: Ensure log directory is writable
  file:
    path: "/var/www{{ app_directory }}/log"
    state: directory
    mode: '0775'
    owner: ec2-user
    group: ec2-user

- name: Ensure development.log is writable
  file:
    path: "/var/www{{ app_directory }}/log/development.log"
    state: touch
    mode: '0664'
    owner: ec2-user
    group: ec2-user

- name: Ensure tmp/miniprofiler directory is writable
  file:
    path: "/var/www{{ app_directory }}/tmp/miniprofiler"
    state: directory
    mode: '0775'
    owner: ec2-user
    group: ec2-user

- name: Install necessary gems
  become: no
  shell: |
    export PATH="$HOME/.rbenv/bin:$HOME/.rbenv/shims:$HOME/.gem/ruby/3.2.3/bin:$PATH"
    bundle install
  args:
    chdir: "/var/www{{ app_directory }}"
    executable: /bin/bash

- name: Fix permissions for /var/www{{ app_directory }}/tmp
  file:
    path: "/var/www{{ app_directory }}/tmp"
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Fix permissions for /var/www/raisetech-live8-sample-app/db/schema.rb
  file:
    path: /var/www/raisetech-live8-sample-app/db/schema.rb
    owner: ec2-user
    group: ec2-user
    mode: '0644'

- name: Run application setup script 
  shell: |
    export PATH="$HOME/.rbenv/bin:$PATH"
    eval "$(rbenv init -)"
    source ~/.bash_profile
    bin/setup
  args:
    chdir: "/var/www{{ app_directory }}"
    executable: /bin/bash
  become_user: ec2-user

- name: Update caniuse-lite database  
  command: /usr/local/bin/npx update-browserslist-db@latest
  args:
    chdir: "/var/www{{ app_directory }}"
  become_user: root

- name: Set permissions for application.css
  file:
    path: "/var/www{{ app_directory }}/app/assets/builds/application.css"
    owner: ec2-user
    group: ec2-user
    mode: '0664'

- name: Precompile application assets  
  shell: |
    export PATH="$HOME/.rbenv/bin:$PATH"
    eval "$(rbenv init -)"
    export PATH="$HOME/.rbenv/shims:$PATH"
    source ~/.bash_profile
    rails assets:precompile
  args:
    chdir: "/var/www{{ app_directory }}"
    executable: /bin/bash
  become_user: ec2-user